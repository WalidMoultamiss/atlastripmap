<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Add fog to a map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    if (!navigator.geolocation) {
      status.textContent = 'Geolocation is not supported by your browser';
    } else {
      const opt = {
        enableHighAccuracy: false,
        timeout: 5000,
        maximumAge: 0
      }
      let defaultJson;
      var marker = new mapboxgl.Marker({
        color: '#F84C4C'
      });

      navigator.geolocation.getCurrentPosition(async ({ coords }) => {
        mapboxgl.accessToken = 'pk.eyJ1IjoieXVzZnV1IiwiYSI6ImNrcXV0cDQ4MDA1NmcyeHA2dW93bzI1aW8ifQ.e09oaWi1aFqdsNdJbJAfjA';

        const { latitude, longitude } = coords;

        map = new mapboxgl.Map({
          container: 'map',
          zoom: 14,
          center: [longitude, latitude],
          pitch: 85,
          bearing: 80,
          style: 'mapbox://styles/mapbox-map-design/ckhqrf2tz0dt119ny6azh975y'
        });

        map.on('load', function () {

          map.addSource('mapbox-dem', {
            'type': 'raster-dem',
            'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
            'tileSize': 512,
            'maxzoom': 14
          });
          map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });

          map.addLayer({
            'id': 'sky',
            'type': 'sky',
            'paint': {
              'sky-type': 'atmosphere',
              'sky-atmosphere-sun': [0.0, 0.0],
              'sky-atmosphere-sun-intensity': 15
            }
          });

          //////////////////////////////
          navigator.geolocation.watchPosition(({ coords }) => {
            const { latitude, longitude } = coords;

            let json = {
              "geometry": {
                "type": "Point",
                "coordinates": [
                  longitude,
                  latitude
                ]
              },
              "type": "Feature",
              "properties": {

              }
            }

            map.flyTo({ center: json.geometry.coordinates, speed: 0.3 });
            requestAnimationFrame(() => marker.setLngLat(json.geometry.coordinates).addTo(map));


            const geo = {
              lan: latitude,
              lon: longitude,
            }

            var msg = {
              type: 'authenticate',
              payload: { token: 'eyJ0eXAiOiFFJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MjU3NTI1MDMsImV4cCI6MTYyODM4MjI0OSwiZGQiOnsiZmlyc3RfbmFtZSI6ImJFFhbGluYSIsISmxhc3RfbmFtZSI6Imhlcm1hbm8iLCJlbWFpbCI6Ik9tZXJfR2lic2FvbkBiYWxpbmEuY29tIiwicGhvbmUiOjU1OTI1MzYyMjd9fQ.73rVedh8vlElTnnAFvMBrBkcEcDJIvXKZLV70jnlEek' }
            };
            const s = new WebSocket('ws://atlastripws.herokuapp.com', [msg.payload.token]);

            // Listen for messages
            s.addEventListener('message', function (event) {
              console.log('Message from server ', event.data);
            });

            setTimeout(() => {
              console.log(JSON.stringify(geo));
              s.send(JSON.stringify(geo));
            }, 3000);




          }, () => { }, opt);

        });
      }, () => { }, opt);
    }

  </script>

</body>

</html>